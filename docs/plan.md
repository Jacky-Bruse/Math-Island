# 数力岛（ShuLi Island / MathPower Island）产品方案（PWA / 平板优先）

## 1. 目标与范围

- 面向平板端的儿童数学与逻辑训练应用
- 三个独立训练入口：**加减法 / 比大小 / 数独**
- 入口内仅包含本类型练习，不进行题型混合
- 支持 PWA 安装与离线使用
- 家庭局域网使用场景下可稳定访问

---

## 2. 信息架构与页面结构

### 2.1 首页（Home）
- 三个大卡片入口（整块可点击，触控友好）：
  - 加减法
  - 比大小
  - 数独
- 首页唯一完整设置入口（低频触发方式，例如长按打开）

### 2.2 加减法入口结构
- 二级选择：**10以内 / 20以内 / 100以内**
- 进入练习页开始训练

### 2.3 比大小入口结构
- 进入即开始训练  
- 比较对象：两位数 **10–99**
- 比较符号仅包含：**“>” / “<”**

### 2.4 数独入口结构
- 二级选择：**4×4 / 6×6 / 8×8（挑战）**
- 进入单盘界面开始训练

### 2.5 休息建议页（Break）
- 训练到达提醒检查点后弹出（15/20 分钟档到点；30 分钟档第 15 分钟与第 30 分钟）
- 支持休息倒计时与继续选项

---

## 3. 设置与生效规则

### 3.1 设置范围（单屏）
- 声音：开 / 关
- 训练时段：**15 / 20 / 30 分钟**（默认 20 分钟）
- 题目提示次数：加减法/比大小 **每题 1 次**（固定）
- 数独提示次数：**每盘 3 次**（固定）
- 数独默认尺寸入口（可选）

### 3.2 设置入口与限制
- 设置仅在首页可修改
- 训练中不提供完整设置入口与参数修改能力
- 训练页提供“静音/取消静音”快捷按钮（仅控制声音，不进入完整设置）
- 修改需中断练习并返回首页

### 3.3 生效时机
- 声音开关：**即时生效**（包含训练中）
- 训练时段、数独默认尺寸：**下一次开始的练习生效**
- 提示次数上限：当前版本固定值，不提供动态配置
- 已开始练习的题目参数不变；若用户在首页修改设置，需重新进入模块才应用新参数

---

## 4. 统一训练节奏与休息机制

### 4.1 训练时段
- 每次训练按设置的 15/20/30 分钟计时
- 15/20 分钟档：到点弹出 1 次休息建议页，不强制中断
- 30 分钟档：第 15 分钟弹出中途休息提醒，第 30 分钟弹出到点休息提醒

### 4.2 休息建议页行为
- 主按钮：休息 3 分钟（倒计时）
- 次按钮按提醒类型区分：
  - 中途提醒（仅 30 分钟第 15 分钟）：`继续训练`，返回正常训练流，不进入收尾阶段
  - 到点提醒（15/20 分钟到点、30 分钟第 30 分钟）：`继续`
    - 加减法/比大小：继续后追加固定 3 题（按有效提交计数，对错都计入）后结束
    - 数独：继续当前盘面，不重置、不换盘
- 休息建议页触发次数：
  - 15/20 分钟档：单次训练触发 1 次（到点）
  - 30 分钟档：单次训练触发 2 次（第 15 分钟与第 30 分钟）
- 中途提醒触发的“休息”倒计时结束自动返回当前训练（正常训练流），不进入收尾阶段
- 到点提醒触发的“休息”倒计时结束后返回到点提醒分支（进入到点后续流程）
- 加减法/比大小在到点提醒点击“继续”后进入“收尾阶段”，完成 3 次有效提交后自动结束本次训练并返回首页
- 数独在到点提醒点击“继续”后不再触发新的休息提醒，直到本盘完成或主动退出
- 数独在到点提醒点击“继续”后，若连续 15 分钟无操作则弹出暂停提示；再 2 分钟无响应则自动保存草稿并返回首页
- 倒计时期间可提前“立即继续”，行为等同于倒计时结束后返回当前训练

### 4.3 退出与返回
- 训练中退出/返回首页需二次确认
- 退出后当前训练计时终止
- 数独盘面可选保留本地草稿用于恢复

### 4.4 训练状态机（实现约束）
- 状态：`Idle -> Running -> BreakPrompt -> Resting/Continue -> Ending -> Idle`
- `Running` 到达提醒检查点后进入 `BreakPrompt`（15/20 分钟到点；30 分钟第 15 与第 30 分钟）
- `BreakPrompt` 选择“休息”进入 `Resting`
- `BreakPrompt` 选择“继续训练”（中途提醒）返回 `Running`
- `BreakPrompt` 选择“继续”（到点提醒）进入 `Continue`
- `Resting` 倒计时结束或“立即继续”按来源分流：
  - 来源为中途提醒：返回 `Running`
  - 来源为到点提醒：返回到点提醒分支并进入到点后续流程（加减法/比大小进入 `Continue`；数独进入 `Continue`）
- 加减法/比大小在 `Continue` 完成 3 次有效提交后进入 `Ending`
- 数独在 `Continue` 保持当前盘，完成盘面或主动退出时进入 `Ending`
- 数独在 `Continue` 连续无操作达到 17 分钟（15 分钟提示 + 2 分钟无响应）时保存草稿并进入 `Ending`
- `Continue`（收尾阶段）仅由到点提醒的 `BreakPrompt` 点击“继续”触发

---

## 5. 加减法模块（10/20/100 以内）

### 5.1 范围与约束（严格规则）
- 10以内：操作数与结果均不超过 10；允许出现 0；减法结果不为负
- 20以内：操作数与结果均不超过 20；允许出现 0；减法结果不为负
- 100以内：操作数与结果均不超过 100；允许进位与退位；允许出现 0；减法结果不为负

### 5.2 交互与输入
- 题面大字号展示：`a + b = ?` 或 `a − b = ?`
- 答案输入使用自定义数字键盘（0–9、退格、清空、确认），不唤起系统键盘
- 每题提交后即时反馈并进入下一题

### 5.3 出题组织（模块内渐进）
- 同一范围内覆盖从简单到接近上限的题目分布
- 100以内逐步提高进位/退位出现比例，保证题目难度分布稳定且可控
- 基础题（无进位/无退位）判定口径：
  - 加法：按十进制逐位相加，各位均不产生进位
  - 减法：按十进制逐位相减，各位均不产生借位，且 `a >= b`
  - 在 100 以内档中，基础题操作数取 `0..99`（不含 100）以避免边界判定歧义；结果仍需满足不超过 100
- 加减法难度分桶（按题号进度滚动）：
  - 定义当前题号 `k = 已完成题数 + 1`，进度 `p = 1 - exp(-k / 30)`（缓升）
  - 说明：`p` 仅由完成题数驱动，与分钟计时解耦；同一训练时长下，答题更快的孩子会进入更高 `p` 区间（预期行为）
  - `p < 0.4`：基础题（无进位/无退位）目标占比 70%
  - `0.4 <= p < 0.8`：基础题与进位/退位题目标占比各 50%
  - `p >= 0.8`：进位/退位题目标占比 70%
- 当已完成题数 `< 10` 时，仅启用前段规则，避免小样本分布失真

### 5.4 提示机制（每题限制 1 次）
- 提示采用轻量步骤化信息：
  - 提醒先算个位再算十位
  - 进位/退位规则提醒
  - 十位/个位的强调式显示用于聚焦关键位
- 第二次错误触发简短分步解释后进入下一题

---

## 6. 比大小模块（两位数 10–99，不启用等号）

### 6.1 范围与按钮
- 数字范围：10–99
- MVP 保持固定 10–99，不提供 1–9 档位
- 判断按钮仅包含：**“>” 与 “<”**
- 题目生成避免相等对

### 6.2 题目分层（模块内渐进）
- 优先分布：十位不同的对比
- 逐步加入：十位相同、比较个位的对比
- 最终混合分布（仍无相等）
- 比大小分布（按题号进度滚动）：
  - 定义当前题号 `k = 已完成题数 + 1`，进度 `p = 1 - exp(-k / 30)`（缓升）
  - 说明：`p` 仅由完成题数驱动，与分钟计时解耦；同一训练时长下，答题更快的孩子会进入更高 `p` 区间（预期行为）
  - `p < 0.4`：十位不同目标占比 80%，十位相同目标占比 20%
  - `0.4 <= p < 0.8`：十位不同与十位相同目标占比各 50%
  - `p >= 0.8`：十位相同目标占比 70%
- 当已完成题数 `< 10` 时，仅启用前段规则，避免小样本分布失真

### 6.3 提示机制（每题限制 1 次）
- 提示与解释采用“先比较十位、十位相同再比较个位”的高亮引导

---

## 7. 数独模块（4×4 / 6×6 / 8×8，统一引擎）

### 7.1 模式定义
- 以完成一盘为单位，进入后保持同一盘面持续填写
- 8×8作为挑战模式单独标识

### 7.2 统一引擎规格（参数化）
- size：4 / 6 / 8
- 宫格尺寸：
  - 4×4：2×2
  - 6×6：2×3
  - 8×8：2×4
- 数据包含：题面 givens（空格为 0）与完整解 solution

### 7.3 题目生成质量要求
- MVP 采用内置预生成题库，不在端上进行在线生成
- 题库质量要求：每盘可解；4×4 与 6×6 唯一解；8×8 目标唯一解率 >= 95%（按发布前抽样题库统计）
- 运行时仅执行：题面加载、冲突检测、提示与完成校验，避免端上重计算带来的卡顿风险
- 预生成题库最小策略允许重复出题；可选增强：启用最近 N 盘不重复队列（建议 `N = 10`）
- V1 可选增强：引入在线生成（建议在 `Web Worker` 中执行），并配置按尺寸的超时与回退策略
- 难度控制基于挖空策略与推理复杂度，避免必须猜的局面

### 7.4 界面与交互
- 点选格子后高亮：同一行/列/宫
- 底部数字面板：1..N + 橡皮擦
- 冲突提示温和且局部，提示冲突位置与冲突原因；不自动清空输入
- 完成校验通过“完成”按钮触发全盘校验；可选实时冲突检查开关

### 7.5 提示机制（每盘限制 3 次）
- 提示形式：给出一个可填位置、给出当前格一个正确数字、指出当前明显冲突点

---

## 8. 儿童友好与可爱 UI 规范

### 8.1 触控与排版
- 主按钮、数字键、数独数字面板均采用大尺寸与大间距
- 信息层级清晰：题面/盘面优先，辅助信息最小化
- 单屏聚焦一个任务，减少干扰元素

### 8.2 视觉风格
- 圆角卡片与柔和阴影层级
- 图标化提示与统一的吉祥物/角色气泡承载简短文案
- 奖励采用贴纸/星星碎片收集形式，不使用分数排名

### 8.3 动效与音效
- 动效短、不阻塞流程
- 音效分级（点击/正确/提示/完成），支持静音
- 休息页降刺激呈现

---

## 9. 本地数据与状态保存

- 保存内容：设置项、最近一次选择的模块与子模式
- 默认不保存逐题历史
- 不统计聚合指标（答题总数、正确率等），减少 MVP 复杂度
- 出题与难度分布按固定规则执行，不依赖历史数据
- 设置中提供“一键清空本地数据”
- 数独盘面可选保存未完成草稿以支持恢复

---

## 10. PWA 与离线能力

- Web App Manifest、应用图标、启动页配置齐全
- 启用离线缓存：缓存应用壳与静态资源，确保弱网/断网可进入并继续训练
- 更新策略：新版本可用时提示刷新，避免训练中资源切换导致异常
- MVP 更新采用“下载与激活分离”：
  - 下载：后台下载新缓存，不中断当前训练
  - 激活：仅在首页空闲态或下次启动时执行
- MVP 不实现自动 Last Known Good（LKG）回退；更新失败时提供“清缓存并重载”手动兜底
- V1 可选增强：引入自动 LKG 回退（按真实故障数据评估后再启用）

---

## 11. 部署与缓存要求（NAS Docker + HTTPS）

- 静态站点部署（构建产物为静态资源）
- HTTPS 访问以满足 PWA 安全上下文
- 缓存策略：
  - 入口页与导航请求采用 `network-first`（短超时后回退缓存），确保可更新且弱网可用
  - 版本化静态资源强缓存以提升加载速度
  - Service Worker 文件不强缓存，避免更新失效
  - 训练进行中不切换资源版本，避免训练中断或白屏

---

## 12. 验收标准

### 12.1 功能正确性
- 加减法三档严格满足“操作数与结果不超过上限”；减法无负数；100以内允许进位/退位；允许出现0
- 比大小仅 “> / <”，无“=”按钮且不出现相等题
- 数独每盘可解；4×4与6×6唯一解；提示次数限制生效；冲突检测准确
- 加减法/比大小按 `p = 1 - exp(-k / 30)` 进行滚动分桶，且当已完成题数 `< 10` 时仅启用前段规则
- 滚动分桶占比验收统计口径：
  - 已完成题数 `< 20`：不进行占比误差验收
  - 已完成题数 `20~29`：按本次训练全量题目统计，占比误差不超过 ±10%
  - 已完成题数 `>= 30`：按最近 30 题滑动窗口统计，占比误差不超过 ±10%

### 12.2 可用性与稳定性
- 触控目标最小尺寸 >= 56×56 CSS px，关键按钮间距 >= 8 CSS px
- 15/20 分钟档在到点触发休息页；30 分钟档在第 15 与第 30 分钟触发休息页；各触发误差 <= ±3 秒
- 加减法/比大小在到点提醒点击“继续”后按有效提交计数严格追加 3 题（对错都计入）并自动结束
- 到点提醒点击“休息”后，休息结束仍能进入到点后续流程（加减法/比大小可达收尾 3 题；数独保持当前盘逻辑）
- 数独在到点提醒点击“继续”后不重置盘面、不再次弹出休息页
- 数独在到点提醒点击“继续”后连续无操作 15 分钟触发暂停提示，再 2 分钟无响应自动保存草稿并返回首页
- 首次联网打开并完成缓存后，断网可进入首页并启动任一模块
- PWA 回归用例通过：首次安装、断网重启、发布新版本后首页刷新、训练中更新不切版本

### 12.3 数独质量验收
- MVP 数独题目来源于预生成题库，不依赖端上在线生成
- 4×4/6×6 抽样 200 盘：唯一解率 100%
- 8×8 抽样 500 盘：唯一解率 >= 95%
- 数独提示次数上限（每盘 3 次）与冲突检测在全尺寸下生效

---

## 13. 技术实现基线（MVP）

- 前端框架：`React + TypeScript`
- 构建工具：`Vite`
- 本地存储分层：
  - `localStorage`：设置项与轻量偏好（声音、训练时段、默认模块/尺寸等）
  - `IndexedDB`：数独草稿、题库去重辅助队列、可扩展训练聚合数据
- 数独引擎策略：
  - MVP：题库优先（不做在线生成）
  - V1 可选：在线生成放入 `Web Worker`，降低主线程阻塞风险
- PWA 工具链：`vite-plugin-pwa`（底层 `Workbox`）
  - MVP 采用 `generateSW`，降低实现复杂度与维护成本
  - 后续如需更细粒度更新控制，再升级为 `injectManifest`
